// Generated by CoffeeScript 1.6.1
(function() {
  var NUMOFPAGE, currentPage, deleteReport, getChildNodeById, getDateStr, getReportNum, getReports, getSubordinateUserAndDepartment, init, initPageInfo, isValidDate, isValidLoginUser, loginPageShowed, pageNum, renderSubordinate, reportTotalNum, reportUserId, reports, setPageState, showPageShowed, subordinatePageShowed, subordinateUserAndDepartments, treeData, validator, writePageShowed;

  loginPageShowed = false;

  writePageShowed = false;

  showPageShowed = false;

  subordinatePageShowed = false;

  init = function() {
    if (window.mobileInitFinished) {
      return;
    }
    window.mobileInitFinished = true;
    console.log("mobile init.");
    $("body").on("pageshow", "#loginPage", function(e) {
      if (loginPageShowed) {
        return;
      }
      loginPageShowed = true;
      return $("#loginSubmitBtn").on("click", function() {
        var data;
        if (isValidLoginUser()) {
          data = {
            userName: $.trim($("#userName").val()),
            password: $.trim($("#password").val())
          };
          return Model.login(data, function(response) {
            if (response.state === 0) {
              return;
            }
            if (response.data === 0) {
              $.mobile.changePage("#loginErrorPage", {
                role: "dialog"
              });
            }
            if (response.data === 1) {
              return $.mobile.changePage("write");
            }
          });
        } else {
          return $.mobile.changePage("#loginErrorPage", {
            role: "dialog"
          });
        }
      });
    });
    $("body").on("pageshow", "#writePage", function(e) {
      if (writePageShowed) {
        return;
      }
      writePageShowed = true;
      return $("#reportSubmitBtn").on("click", function() {
        var contentStr, data, dateStr;
        if (isValidDate()) {
          dateStr = $.trim($("#dateTxt").val());
          contentStr = $.trim($("#content").val());
          data = {
            date: dateStr,
            content: contentStr
          };
          return Model.createReport(data, function(response) {
            if (response.state === 0) {
              return;
            }
            return window.location.href = "/m/show";
          });
        } else {
          return $.mobile.changePage("#writeErrorPage", {
            role: "dialog"
          });
        }
      });
    });
    $("body").on("pageshow", "#showPage", function(e) {
      initPageInfo();
      getReports();
      getReportNum();
      if (showPageShowed) {
        return;
      }
      showPageShowed = true;
      $("#reportList").on("taphold", "li", function(e) {
        var reportId;
        reportId = $(this).attr('reportId');
        $("#deleteReportBtn").attr("reportId", reportId);
        $("#deleteReportMenu").popup();
        return $("#deleteReportMenu").popup('open');
      });
      $("#deleteReportMenu").on("click", "#deleteReportBtn", function(e) {
        var reportId;
        reportId = $(this).attr('reportId');
        deleteReport(reportId);
        return $("#deleteReportMenu").popup('close');
      });
      $("#deleteReportMenu").on("click", "#cancelDeleteReportBtn", function(e) {
        return $("#deleteReportMenu").popup('close');
      });
      $("div.pagePre").on("click", "button", function(e) {
        currentPage -= 1;
        setPageState();
        getReports();
        return console.log("pre button clicked." + currentPage);
      });
      return $("div.pageNext").on("click", "button", function(e) {
        currentPage += 1;
        setPageState();
        getReports();
        return console.log("next button clicked." + currentPage);
      });
    });
    return $("body").on("pageshow", "#subordinatePage", function(e) {
      var treeData;
      treeData = [];
      $("#subordinatePage a.headerBack").css("display", "none");
      $("#subordinatePage h1").empty();
      $("#subordinatePage h1").append("下属日报");
      getSubordinateUserAndDepartment();
      if (subordinatePageShowed) {
        return;
      }
      subordinatePageShowed = true;
      return $("#subordinatePage a.headerBack").click(function() {
        treeData.pop();
        renderSubordinate(treeData[treeData.length - 1], "#subordinatePage div.subordinate");
        if (treeData.length === 1) {
          $("#subordinatePage a.headerBack").css("display", "none");
          $("#subordinatePage h1").empty();
          return $("#subordinatePage h1").append("下属日报");
        }
      });
    });
  };

  isValidLoginUser = function() {
    var pw, un;
    un = $.trim($("#userName").val());
    pw = $.trim($("#password").val());
    return un.length >= 2 && un.length <= 25 && pw.length >= 7 && pw.length <= 25;
  };

  getDateStr = function(date) {
    var month, today, year;
    today = new Date();
    year = date.getFullYear();
    month = date.getMonth() + 1;
    date = date.getDate();
    return "" + year + "-" + month + "-" + date;
  };

  validator = new Validator();

  isValidDate = function() {
    var contentStr, date, dateStr, months, year, _ref;
    dateStr = $.trim($("#dateTxt").val());
    contentStr = $.trim($("#content").val());
    try {
      validator.check(contentStr).notEmpty();
      validator.check(dateStr).notEmpty();
      _ref = dateStr.split("-"), year = _ref[0], months = _ref[1], date = _ref[2];
      validator.check(year).notNull().isNumeric().len(4, 4);
      validator.check(months).notNull().isNumeric().len(1, 2);
      validator.check(date).notNull().isNumeric().len(1, 2);
      return true;
    } catch (error) {
      return false;
    }
  };

  NUMOFPAGE = 2;

  reports = [];

  reportTotalNum = 0;

  pageNum = 0;

  currentPage = 1;

  reportUserId = null;

  initPageInfo = function() {
    reports = [];
    reportTotalNum = 0;
    pageNum = 0;
    currentPage = 1;
    return reportUserId = null;
  };

  getReports = function() {
    var data;
    data = {
      page: currentPage,
      numOfPage: NUMOFPAGE,
      userId: reportUserId
    };
    return Model.getReports(data, function(response) {
      var report, reportHTML, _i, _len, _ref, _results;
      if (response.state === 0) {
        return;
      }
      reports = [];
      $("#reportList ul").empty();
      _ref = response.data;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        report = _ref[_i];
        reports.push(report);
        reportHTML = "<li class='report' reportId='" + report.id + "'><p class='date'><i class='icon-calendar'></i><span>" + report.date + "</span></p>                  <div class='content'>" + report.content + "</div></li>";
        _results.push($("#reportList ul").append(reportHTML));
      }
      return _results;
    });
  };

  deleteReport = function(reportId) {
    return Model.deleteReport({
      reportId: reportId
    }, function(response) {
      if (response.state === 0) {
        return;
      }
      reportTotalNum -= 1;
      if (reports.length === 1 && currentPage > 1) {
        currentPage -= 1;
      }
      setPageState();
      return getReports();
    });
  };

  getReportNum = function() {
    return Model.getReportNum(reportUserId, function(response) {
      if (response.state === 1) {
        reportTotalNum = response.data;
      }
      return setPageState();
    });
  };

  setPageState = function() {
    pageNum = Math.ceil(reportTotalNum / NUMOFPAGE);
    if (pageNum === 0) {
      pageNum = 1;
    }
    $("div.pagetip").empty();
    $("div.pagetip").append("" + currentPage + "/" + pageNum);
    if (pageNum === 1) {
      return $("div.pageination").hide();
    } else if (currentPage === 1) {
      $("div.pageination").show();
      $("div.pagePre").hide();
      return $("div.pageNext").show();
    } else if (currentPage === pageNum) {
      $("div.pageination").show();
      $("div.pagePre").show();
      return $("div.pageNext").hide();
    } else {
      $("div.pageination").show();
      $("div.pagePre").show();
      return $("div.pageNext").show();
    }
  };

  subordinateUserAndDepartments = null;

  getSubordinateUserAndDepartment = function() {
    return Model.getSubordinateUserAndDepartment(function(response) {
      if (response.state === 0) {
        return;
      }
      subordinateUserAndDepartments = response.data;
      renderSubordinate(subordinateUserAndDepartments, "#subordinatePage div.subordinate", true);
      return console.log(subordinateUserAndDepartments);
    });
  };

  treeData = [];

  renderSubordinate = function(data, nodeContainer, pushStack) {
    var node, nodeData, treeNodeData, _i, _len;
    if (pushStack == null) {
      pushStack = false;
    }
    $(nodeContainer).empty();
    $(nodeContainer).append("<ul class='root' data-role='listview' data-inset='true' data-filter='true'></ul>");
    treeNodeData = [];
    node = "" + nodeContainer + " ul.root";
    for (_i = 0, _len = data.length; _i < _len; _i++) {
      nodeData = data[_i];
      treeNodeData.push(nodeData);
      if (nodeData.children) {
        $(node).append("<li id='" + nodeData.id + "-node' node='1' onclick='clickNode(event)'><a href='#'>" + nodeData.label + "</a></li>");
      } else {
        $(node).append("<li id='" + nodeData.id + "-node' onclick='showUserReport(event)'><a href='#'>" + nodeData.label + "</a></li>");
      }
    }
    if (pushStack) {
      treeData.push(treeNodeData);
    }
    return $("" + nodeContainer + " ul.root").listview();
  };

  window.clickNode = function(event) {
    var id, isNode, _, _ref;
    _ref = $(event.currentTarget).attr("id").split("-"), id = _ref[0], _ = _ref[1];
    isNode = $(event.currentTarget).attr("node") && true;
    $("#subordinatePage a.headerBack").css("display", "inline");
    $("#subordinatePage h1").empty();
    return getChildNodeById(subordinateUserAndDepartments, id);
  };

  getChildNodeById = function(dataSource, id) {
    var nodeData, _i, _len;
    for (_i = 0, _len = dataSource.length; _i < _len; _i++) {
      nodeData = dataSource[_i];
      if (nodeData.id === id) {
        $("#subordinatePage h1").append(nodeData.label);
        renderSubordinate(nodeData.children, "#subordinatePage div.subordinate", true);
        return;
      }
      if (nodeData.children) {
        getChildNodeById(nodeData.children, id);
      }
    }
  };

  window.showUserReport = function(event) {
    var id, _, _ref;
    _ref = $(event.currentTarget).attr("id").split("-"), id = _ref[0], _ = _ref[1];
    return console.log(id);
  };

  window.init = init;

}).call(this);
